
<!DOCTYPE html>
<html>
<head>
  <title>Rotten Eggs :: Hongik!</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <script type = "text/javascript" src = "http://paperjs.org/assets/js/paper.js"></script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?clientId=RZrvWOXzFf2fbBQZF2tY"></script>
  <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?clientId=RZrvWOXzFf2fbBQZF2tY&submodules=geocoder"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
    }

    #map {
      width: 100%;
      height: calc(100% - 470px);
    }

    #nav {
      width: 100%;
      height: 70px;
      padding: 10px;

      background-color: #ececec;

      font-family: 'nanumgothic';
      font-size: 30px;
      text-align: center;

      box-sizing: border-box;
    }

    canvas {
      display: block;
      margin: 0 auto;
      width: 1200px;
      height: 400px;
      background-color : white;
    }
  </style>
</head>
<body>
  <div id="nav">[Rotten Egg Hongik :: 서교/동교/망원] 우리동네 식당 신선도는 몇프로?</div>
  <canvas id="canvas-1"></canvas>
  <div id="map"></div>
  <script type="text/javascript">
    var character
  </script>
  <script type="text/paperscript" canvas="canvas-1">
    var MyCharacterClass = function(){
      this.address = new PointText({
        point:[460,100],
        content:"",
        fontSize: 40
      });
      this.index = new PointText({
        point:[460,260],
        content:"산정중...",
        fontSize: 150
      });
      this.text = new PointText({
        point:[460,340],
        content:"이 동네 음식점의 신선지수 평가중입니다...",
        fontSize: 40
      });

      this.albumen = new Path({
             segments: [[30,40], [150,0], [220,0], [300,70], [320,120], [300,180], [280,240], [200,300], [60,290], [30,250], [-20,180], [0,130]],
             closed: true
         });
      this.albumen.style = {
           fillColor: '#fcfcfc',
           strokeColor: '#efefef',
           strokeWidth: 5
         };
      this.albumen.smooth({
           type: 'catmull-rom',
           factor: 0.4
       });
       this.vitellus = new Shape.Circle([150,150], 76);
       this.vitellus.style = {
         fillColor: '#ffd500',
         strokeWidth: 5
       };


       /* 눈 */
       this.sclera = new Shape.Ellipse({
         center: [0, 0],
         radius: [30, 38],
         fillColor: 'white',
         strokeColor: '#efe3e8',
         strokeWidth: 4
       });

       this.iris = new Shape.Circle({
         center: [10, 0],
         radius: 15,
         fillColor: '#661fb4',
         strokeColor: '#220a3c',
         strokeWidth: 4
       });

       this.pupil = new Shape.Circle({
         center: [10, 0],
         radius: 9,
         fillColor: '#220a3c',
       });

       this.highlight = new Shape.Circle({
         center: [15, -8],
         radius: 3,
         fillColor: 'white'
       });

       this.eye = new Group([this.sclera, this.iris, this.pupil, this.highlight]);
       this.eye.position = [143,150];

       this.eye_l = this.eye.clone();
       this.eye.position.x += 50;



       /* 팔 */
       this.arm_origin = new Point(15, 0);
       this.arm_joint = new Point(25, 70);
       this.arm_end = new Point(0, 140);

       this.arm_path = new Path({
           segments: [this.arm_origin, this.arm_joint, this.arm_end],
           closed: false,
           strokeColor: '#222',
           strokeWidth: 20,
       });

       this.arm_path.smooth({
         type: 'continuous'
       });
       this.arm_path.strokeCap = 'round';

       this.arm = new Group([this.arm_path]);
       this.arm.position.y =+ 250;
       this.arm_l = this.arm.clone();
       this.arm_l.position.x -= 20;
       this.arm_l.children[0].pivot = this.arm_l.children[0].segments[0].point;
       this.arm_l.rotate(20);
       this.arm_r = this.arm.clone();
       this.arm_r.position.x += 310;
       this.arm_r.children[0].pivot = this.arm_r.children[0].segments[0].point;
       this.arm_r.position.y -= 80;
       this.arm_r.rotate(50);

       this.arm_r.rotate(-70);
       this.arm_r.position.x -= 15;
       this.arm_r.position.y += 70;
       this.arm_l.rotate(180);
       this.arm_l.position.y -= 5;

       this.arm.visible = false;

       this.arm_l.applyMatrix = false;
       this.arm_r.applyMatrix = false;
       this.eyebrow_l = new Path({
         segments:[[185, 113], [230, 133]],
         closed: false,
         strokeColor: 'black',
         strokeWidth: 10
       });
       this.eyebrow_r = new Path({
         segments:[[115, 133], [160, 113]],
         closed: false,
         strokeColor: 'black',
         strokeWidth: 10
       });

       this.eyebrow = new Group([this.eyebrow_r, this.eyebrow_l]);
       this.eyebrow_r.visible = false;
       this.eyebrow_l.visible = false;

       this.smile = new Path({
         segments : [[130, 180],[175, 200], [220, 180]],
         closed : false,
         strokeColor: 'black',
         strokeWidth: 10
       });

       this.smile.smooth({
           type: 'continuous'
         });
      this.smile.visible = false;
       /* 다리 */
       this.leg_origin = new Point(0, 0);
       this.leg_joint = new Point(10, 40);
       this.leg_end = new Point(0, 80);

       this.socksColor = new Gradient({
           stops: [['#222', 0.15], ['white', 0.15], ['white', 0.25], ['#661fb4', 0.25],
           ['#661fb4', 0.35], ['white', 0.35], ['white', 0.4], ['#661fb4', 0.4], ['#661fb4', 0.5],['white', 0.5]],
           origin: this.leg_joint,
           destination: this.leg_end
       });
       this.socks = new Color(this.socksColor, this.leg_joint, this.leg_end);

       this.leg_path = new Path(this.leg_origin, this.leg_joint, this.leg_end);
       this.leg_path.strokeColor = this.socks;
       this.leg_path.strokeWidth = 25;
       this.leg_path.smooth({
         type: 'continuous'
       });

       this.shoes = new Path({
         segments : [[0,5], [30,5], [25,17], [50,17], [55,35], [0,35]],
         closed: true,

         fillColor: '#692c21',
         strokeColor: '#56241b',
         strokeWidth: 3
       });

       this.shoes.smooth({
           type: 'continuous',
           from: 2,
           to: 4
       });
       this.shoes.rotate(20);
       this.shoes.position.x -= 15;
       this.shoes.position.y += 70;
       this.leg = new Group([this.leg_path, this.shoes]);
       this.leg.position.x =+ 150;
       this.leg.position.y =+ 350;

       this.leg_l = this.leg.clone();
       this.leg_l.position.x -= 40;
       this.leg_l.position.y -= 5;

       this.leg_r = this.leg.clone();
       this.leg_r.position.x += 60;
       this.leg_r.rotate(-20);

       this.leg.visible = false;



       this.egg_body = new Group ([this.albumen, this.vitellus]);
      //this.eye = new Group([this.sclera, this.iris, this.pupil, this.highlight]);
       this.eyes = new Group([this.eye, this.eye_l, this.eyebrow_r, this.eyebrow_l, this.smile]);
       //this.arm = new Group([this.arm_path]);
       this.arms = new Group([this.arm_l, this.arm_r]);
       //this.leg_path = new Path(this.leg_origin, this.leg_joint, this.leg_end);
       //this.leg = new Group([this.leg_path, this.shoes]);
       this.legs = new Group([this.leg_l, this.leg_r]);
       this.character = new Group([this.legs, this.arms, this.egg_body, this.eyes, this.text, this.index, this.grade]);

       this.character.applyMatrix = false;
       this.character.scale(0.7);

       this.character.applyMatrix = false;
       this.sad = function(){

       //arms
       this.arm_l.strokeColor = '#ffd500';
       this.arm_r.strokeColor = '#ffd500';


       //legs
       this.leg_l.strokeColor = 'black';
       this.leg_r.strokeColor = 'black';

       //shoes
       this.shoes.style = {
         strokeColor : "black",
         fillColor : "black"
       };

       //face
       this.albumen.style = {
         strokeColor : "black",
         fillColor : "black"
       };

       //eyes
       this.pupil.style = {
         strokeColor : "black",
         strokeWidth : 3,
         fillColor : "black"
       };

       this.pupil.style = {
         strokeColor : "black",
         strokeWidth : 3,
         fillColor : "black"
       };
       this.index.fillColor = 'red';
       this.text.fillColor = 'red';
       this.grade.fillColor = 'red';

       this.eyebrow_r.visible = true;
       this.eyebrow_l.visible = true;
       }
       this.arm.applyMatrix = false;

       this.happy = function() {
         this.index.fillColor = 'blue';
         this.text.fillColor = 'blue';
         this.grade.fillColor = 'blue';

         this.albumen.fillColor = 'blue';
         this.albumen.strokeColor='blue';

         this.smile.visible = true;

         this.arm_l.strokeColor = '#222';
         this.arm_r.strokeColor = '#222';
      }

      this.normal = function(){
        this.grade.fillColor = 'black';
        this.index.fillColor = 'black';
        this.text.fillColor = 'black';
        this.smile.visible = false;
        this.eyebrow.visible = false;


        this.albumen.style = {
             fillColor: '#fcfcfc',
             strokeColor: '#efefef',
             strokeWidth: 5
           };

        this.albumen.smooth({
             type: 'catmull-rom',
             factor: 0.4
           });

         this.vitellus.style = {
           fillColor: '#ffd500',
           strokeWidth: 5
         };
      }

      this.changeText = function(forContent){
        this.text.content = forContent;
      }
      this.changeAddress = function(forContent){
        this.address.content = forContent;
      }
      this.changeGrade = function(forContent){
        this.grade.content = forContent;
      }
    }
    character = new MyCharacterClass();

  </script>
  <script type="text/javascript">
    /* naver map basic api code */
    var startCount = 1;
    var endCount = 1000;
    var currentAddress = "default";
    var dongGyo = [];
    var seoGyo = [];
    var mangOne = [];
    var area;

    var map = new naver.maps.Map('map', {
      center: new naver.maps.LatLng(37.5666805, 126.9784147),
      zoom: 13,
      mapTypeId: naver.maps.MapTypeId.NORMAL
    });

    var infowindow = new naver.maps.InfoWindow();

    $(window).on("load", function() {
      loadXML('http://openAPI.mapo.go.kr:8088/67695847446d6573353664736e6d50/xml/MpAdminMesureFood/' + startCount + '/' + endCount + '/');
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation);
      } else {
        var center = map.getCenter();
        infowindow.setContent('<div style="padding:20px;"><h5 style="margin-bottom:5px;color:#f00;">Geolocation not supported</h5>'+ "latitude: "+ center.lat() +"<br />longitude: "+ center.lng() +'</div>');
        infowindow.open(map, center);
      }
    });

    function onSuccessGeolocation(position) {
      var location = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

     map.setCenter(location); // 얻은 좌표를 지도의 중심으로 설정합니다.
     searchCoordinateToAddress(location);
     infowindow.open(map, location);
    }

    function onErrorGeolocation() {
        var center = map.getCenter();

        infowindow.setContent('<div style="padding:20px;">' +
            '<h5 style="margin-bottom:5px;color:#f00;">Geolocation failed!</h5>'+ "latitude: "+ center.lat() +"<br />longitude: "+ center.lng() +'</div>');

        infowindow.open(map, center);
    }


    function searchCoordinateToAddress(latlng) {
      var tm128 = naver.maps.TransCoord.fromLatLngToTM128(latlng);

      naver.maps.Service.reverseGeocode({
          location: tm128,
          coordType: naver.maps.Service.CoordType.TM128
      }, function(status, response) {
          if (status === naver.maps.Service.Status.ERROR) {
            return alert('Something Wrong!');
          }

          var items = response.result.items,
            htmlAddresses = [];

          for (var i=0, ii=items.length, item, addrType; i<ii; i++) {
            item = items[i];
            addrType = item.isRoadAddress ? '[도로명 주소]' : '[지번 주소]';
          }
          window.currentAddress = item.address;
          infowindow.setContent(
           '<div style="padding:20px;">' +
           '현위치<br>'+ this.currentAddress +'</div>');
          character.changeAddress(currentAddress);
          setArea();
      });
    }

    // result by latlng coordinate
    function searchAddressToCoordinateAndMark(address, areaName) {
        naver.maps.Service.geocode({
            address: address
        }, function(status, response) {
            if (status === naver.maps.Service.Status.ERROR) {
            }
            var item = response.result.items[0],
                addrType = item.isRoadAddress ? '[도로명 주소]' : '[지번 주소]',
                point = new naver.maps.Point(item.point.x, item.point.y);
            console.log(item.address);
            areaName[3] = new naver.maps.Marker({
                position: point,
                map: map,
                icon: {
                  url: 'img/marker/bad.png'
                }
            });
            areaName[4]= new naver.maps.InfoWindow();
            areaName[4].setContent('<div style="padding:20px;">' + areaName[1] + '<hr>' + areaName[2] + '</div>');

            naver.maps.Event.addListener(areaName[3], 'click', function(){areaName[4].open(map, point)});
        });
    }

    function loadXML(url)
    {
      var request = new XMLHttpRequest();
      request.open("GET", url, true);
      request.onload = function()
      {
        if(request.readyState == 4)
        {
          if(request.status == 200)
          {
            var temp = request.responseXML;
            var totalCount = temp.getElementsByTagName("list_total_count")[0].childNodes[0].nodeValue;
            var address;

            for(var i = startCount; i < endCount ; i++) {
              if(temp.getElementsByTagName("DISPO_CTN_DT")[i].childNodes[0].nodeValue.match('폐쇄')) {
                continue;
              }

              address = temp.getElementsByTagName("SITE_ADDR")[i].childNodes[0].nodeValue;

              switch (area) {
                case 1:
                  if(address.match('동교')) {
                    dongGyo[dongGyo.length] = [];
                    dongGyo[dongGyo.length - 1][0] = address;
                    dongGyo[dongGyo.length - 1][1] = temp.getElementsByTagName("UPSO_NM")[i].childNodes[0].nodeValue;
                    //dongGyo[dongGyo.length - 1][2] = temp.getElementsByTagName("BAS_LAW")[i].childNodes[0].nodeValue;
                    searchAddressToCoordinateAndMark(dongGyo[dongGyo.length - 1][0], dongGyo[dongGyo.length - 1]);
                  }
                break;

                case 2:
                  if (address.match('서교')) {
                    seoGyo[seoGyo.length] = [];
                    seoGyo[seoGyo.length - 1][0] = address;
                    seoGyo[seoGyo.length - 1][1] = temp.getElementsByTagName("UPSO_NM")[i].childNodes[0].nodeValue;
                    seoGyo[seoGyo.length - 1][2] = temp.getElementsByTagName("BAS_LAW")[i].childNodes[0].nodeValue;
                    searchAddressToCoordinateAndMark(seoGyo[seoGyo.length - 1][0], seoGyo[seoGyo.length - 1]);
                  }
                break;

                case 3:
                  if (address.match('망원')) {
                    mangOne[mangOne.length] = [];
                    mangOne[mangOne.length - 1][0] = address;
                    mangOne[mangOne.length - 1][1] = temp.getElementsByTagName("UPSO_NM")[i].childNodes[0].nodeValue;
                    //mangOne[mangOne.length - 1][2] = temp.getElementsByTagName("BAS_LAW")[i].childNodes[0].nodeValue;
                    searchAddressToCoordinateAndMark(mangOne[mangOne.length - 1][0], mangOne[mangOne.length - 1]);
                  }
                break;

                default:
              }
            }
          }
        }
      }
      request.send();
    }

   function setArea() {
     if(currentAddress.match('동교')){
       area = 1;
     }
     else if(currentAddress.match("서교")){
       area = 2;
     }
     else if(currentAddress.match("망원")) {
       area = 3;
     }
   }
  </script>

</body>
</html>
